#!/bin/bash
#
# Copyright (C) 2009  Jonas Bernoulli <jonas@bernoul.li>
#
# This file is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3, or (at your option)
# any later version.
#
# Created: 20090715
# Updated: 20091004
# Version: 002 (this file)

version="002"

usage() {
    cat <<EOF
Usage: redigest

Update unmerged manifests and try to continue rebasing (which doesn't
have an effect when merging and fails if there are other conflicts).
An exit status of 1 means you are not done yet with this commit.

Options:
  --version             show version number and exit
  -h, --help            show this help message and exit
EOF
}

case $1 in
-h|--help) usage && exit ;;
--version) echo "redigest-$version" ;;
esac

for manifest in $(git ls-files -m | uniq)
do
    package=${manifest%/Manifest}
    ebuild $(git ls-files -i -x "$package/*\.ebuild" | tail -n 1) digest
    git add $manifest
done

git rebase --continue |& grep -v "No rebase in progress?"
